@page "/schedule"
@attribute [Authorize(Roles = "Patient, Dentist")]

@using Microsoft.AspNetCore.Authorization;
@using System.Linq
@using Radzen
@using Components
@using Interfaces.Models.Input

@inject DialogService DialogService
@inject IScheduleService ScheduleService

<div class="row">
    <div class="col-md-12">
    <RadzenScheduler @ref="scheduler" style="height: 768px;" TItem="TreatmentSessionViewModel" Data="@AppointmentsData" StartProperty="Start" EndProperty="End" 
        TextProperty="Reason" SelectedIndex="2" 
        SlotSelect="@OnSlotSelect" AppointmentSelect="@OnAppointmentSelect" AppointmentRender="@OnAppointmentRender">
        <RadzenDayView />
        <RadzenWeekView />
        <RadzenMonthView />
    </RadzenScheduler>
    </div>
</div>

@code {
    [CascadingParameter]
    public Task<AuthenticationState> AuthenticationStateTask { get; set; }

    RadzenScheduler<TreatmentSessionViewModel> scheduler;

    IList<TreatmentSessionViewModel> AppointmentsData { get; set; }

    protected override async Task OnInitializedAsync()
    {
        AppointmentsData = await GetAppointmentsAsync();
    }
    async Task OnSlotSelect(SchedulerSlotSelectEventArgs args)
    {
        var user = (await AuthenticationStateTask).User;
        if (user.IsInRole("Dentist"))
        {
            return;
        }
        
        DTO.Input.TreatmentSessionInput data = await DialogService.OpenAsync<EditAppointment>(
            "Add Treatment Session",
            new Dictionary<string, object> 
            { 
                { 
                    "TreatmentSession", new TreatmentSessionViewModel() 
                    { 
                        Start = args.Start,
                        End = args.End,
                        Reason = string.Empty,
                        DentalTeam = new DentalTeamViewModel()
                        { 
                            ReferenceId = Guid.Empty
                        }
                    } 
                } 
            });

        if (data != null)
        {
            await ScheduleService.AddAppointmentsAsync(data);

            AppointmentsData = await GetAppointmentsAsync();
            
            // Either call the Reload method or reassign the Data property of the Scheduler
            scheduler.Reload();
        }
    }

    async Task OnAppointmentSelect(SchedulerAppointmentSelectEventArgs<TreatmentSessionViewModel> args)
    {
        DTO.Input.TreatmentSessionInput data = null;

        var user = (await AuthenticationStateTask).User;
        if (user.IsInRole("Patient"))
        {
            data = await DialogService.OpenAsync<EditAppointment>("Approve Appointment", 
                new Dictionary<string, object> { { "TreatmentSession", args.Data } });
        }
        else if (user.IsInRole("Dentist"))
        {
            data = await DialogService.OpenAsync<ApproveAppointment>("Approve Appointment", 
                new Dictionary<string, object> { { "TreatmentSession", args.Data } });
        }

        if (data == null)
        {
            return;
        }

        await ScheduleService.EditAppointmentsAsync(data);

        AppointmentsData = await GetAppointmentsAsync();

        scheduler.Reload();
    }

    void OnAppointmentRender(SchedulerAppointmentRenderEventArgs<TreatmentSessionViewModel> args)
    {
        // Never call StateHasChanged in AppointmentRender - would lead to infinite loop
        if (args.Data.Status == "Requested")
        {
            args.Attributes["style"] = "background: orange";
        }
        else if (args.Data.Status == "Accepted")
        {
            args.Attributes["style"] = "background: blue";
        }
        else 
        {
            args.Attributes["style"] = "background: red";
        }
    }

    private async Task<IList<TreatmentSessionViewModel>> GetAppointmentsAsync()
    {
        return (await ScheduleService.GetAppointmentsAsync(
                DateTimeOffset.UtcNow.AddMonths(-1),
                DateTimeOffset.UtcNow.AddMonths(1)
            ));
    }
}